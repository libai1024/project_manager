# 外包项目管理系统 - 后端迁移重构跟踪

> 目标：在不破坏现有功能的前提下，完成企业级工程化迁移（PostgreSQL + Alembic + 应用工厂 + 分层/模块化 + 自动化测试）。

## 0. 当前原则

- 先读透再改（避免大规模回归）。
- 迁移优先级：**迁移地基（DB/Alembic） > 应用工厂（create_app） > 分层与 DTO 拆分 > 模块渐进重构**。
- 每个里程碑结束都要能：
  - 启动后端
  - 通过基础冒烟测试（登录 -> 带 token 调用核心接口）

## 1. 已完成阅读（核心认知）

### 1.1 Core

- `fastapi_back/app/core/config.py`
  - 使用 `pydantic-settings` 读取 `.env`，默认 `DATABASE_URL=sqlite:///./project_manager.db`。
- `fastapi_back/app/core/database.py`
  - 直接创建全局 `engine`，包含 SQLite 专用 `check_same_thread`。
- `fastapi_back/app/core/security.py`
  - JWT + refresh token，且 token 时长可从 `system_settings` 读取。
- `fastapi_back/app/core/dependencies.py`
  - `get_current_user` 认证逻辑较重，包含大量调试日志，并依赖 token blacklist。

### 1.2 Exceptions

- `fastapi_back/app/exceptions/handlers.py`
  - 统一异常响应结构：`{error,message,code,details}`。
  - 与 `docs/1.0.0/API_DESIGN.md` 设想不一致，后续采用“兼容演进”。

### 1.3 API / Services（已读）

- `fastapi_back/app/api/auth.py`
  - 认证逻辑较完整，路由层直接编排 repositories。
- `fastapi_back/app/api/projects.py`
  - 使用 `ProjectService`，但路由层仍有部分业务编排（例如 `update_step` 里读取旧状态并写日志）。
- `fastapi_back/app/services/project_service.py`
  - 编排：创建默认步骤/文件夹/日志、自动结账等。
- `fastapi_back/app/api/platforms.py`
  - 标准结构：API -> `PlatformService`。
- `fastapi_back/app/api/system_settings.py`
  - API 直接调用 repository，包含 JSON 解析散落逻辑，适合后续引入 `SystemSettingsService`。
- `fastapi_back/app/api/tags.py`
  - API 直接调用 repository 并手工组装 `TagRead`。

### 1.4 Models

- `fastapi_back/app/models/user.py`
  - ORM（`User(table=True)`）与 DTO（`UserCreate/UserRead/.../Token`）混在同文件。
  - 后续建议引入 `app/schemas/*` 逐步拆分。

## 2. 模块地图（路由清单）

当前 `main.py` 注册的路由模块（全部在 `fastapi_back/app/api`）：

- `auth`
- `platforms`
- `projects`
- `dashboard`
- `users`
- `attachments`
- `attachment_folders`
- `todos`
- `project_logs`
- `step_templates`
- `project_parts`
- `github_commits`
- `video_playbacks`
- `historical_projects`
- `system_settings`
- `tags`

## 3. 重构目标形态（落地优先级）

### 3.1 数据库与迁移

- 目标：PostgreSQL 为默认主库；SQLite 作为可选开发模式。
- 引入 Alembic：
  - 生成 baseline migration
  - 移除 `SQLModel.metadata.create_all(engine)`
  - 禁止通过脚本 `migrate_*.py` 直接改生产库

### 3.2 应用工厂

- 引入 `create_app()`：
  - 注册中间件、异常处理器、路由
  - main.py 只负责 `app = create_app()`

### 3.3 分层与 DTO 拆分

- 分层：API -> Service -> Repository。
- DTO 从 `app/models/*` 拆到 `app/schemas/*`（渐进）。

### 3.4 日志与异常

- 日志默认降噪：敏感 header/token 仅 debug 级别。
- 异常响应保持兼容，后续再引入 envelope。

## 4. 重构执行顺序（建议）

- 第 1 阶段（地基，不改业务）：
  - Alembic + baseline migration
  - database engine 按 driver 处理 sqlite/postgres
  - 应用工厂 create_app

- 第 2 阶段（低风险模块先规范化）：
  - platforms / tags / system_settings
  - 逐步引入 service（若缺失）与 schemas 拆分

- 第 3 阶段（高风险模块）：
  - projects / auth / attachments

## 5. 自动化测试（计划）

### 5.1 目标

- 用脚本自动化验证：
  - 登录拿 token
  - 携带 token 对各模块进行 CRUD/冒烟调用
  - 输出“已覆盖 / 未覆盖接口列表”

### 5.2 推荐实现

- 基础方案（最快落地）：`bash + curl + jq`
- 更强方案（可维护）：Python 脚本使用 `httpx`

## 6. 下一步（正在推进）

- 继续阅读：`attachments/todos/users/dashboard/step_templates/...` 与关键 repositories。
- 完成模块风险分级与改造切入点清单。
- 开始落地 Alembic（建立 baseline migration）。
- 设计 API 冒烟测试脚本（覆盖清单 + 自动执行）。

